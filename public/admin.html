<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
      background: linear-gradient(135deg, #4f46e5, #9333ea);
      min-height: 100vh;
      padding: 22px;
      color: #111827;
    }

    .wrap { max-width: 1100px; margin: 0 auto; }

    .topbar {
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid rgba(255,255,255,0.7);
      border-radius: 16px;
      padding: 16px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.18);
      backdrop-filter: blur(8px);
    }

    .brand { display: flex; gap: 12px; align-items: center; }

    .logo {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, #4f46e5, #9333ea);
      box-shadow: 0 10px 20px rgba(79, 70, 229, 0.35);
    }

    .brand h2 { margin: 0; font-size: 18px; font-weight: 800; letter-spacing: 0.2px; }
    .sub { margin: 2px 0 0; font-size: 13px; color: #4b5563; font-weight: 600; }

    .right { display: flex; gap: 10px; align-items: center; }

    .chip {
      padding: 8px 10px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      font-weight: 700;
      font-size: 13px;
      border: 1px solid #e0e7ff;
      white-space: nowrap;
    }

    .btn {
      border: none;
      cursor: pointer;
      font-weight: 800;
      border-radius: 10px;
      padding: 10px 12px;
      transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
      background: linear-gradient(135deg, #4f46e5, #9333ea);
      color: #fff;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 22px rgba(79, 70, 229, 0.35);
    }

    .btn:disabled { cursor: not-allowed; opacity: 0.75; transform: none; box-shadow: none; }

    .btn.secondary {
      background: #ffffff;
      color: #111827;
      border: 1px solid #e5e7eb;
      box-shadow: none;
    }

    .btn.secondary:hover { box-shadow: 0 10px 18px rgba(0,0,0,0.08); }

    .grid {
      margin-top: 16px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    @media (min-width: 900px) {
      .grid { grid-template-columns: 420px 1fr; align-items: start; }
    }

    .card {
      background: rgba(255, 255, 255, 0.94);
      border: 1px solid rgba(255,255,255,0.7);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.18);
      backdrop-filter: blur(8px);
    }

    .card h3 { margin: 0 0 12px; font-size: 16px; font-weight: 900; }

    .form-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }

    .form-grid input,
    .form-grid select,
    #delete_employee_id {
      width: 100%;
      padding: 12px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      outline: none;
      font-size: 14px;
      background: #fff;
      transition: 0.2s ease;
    }

    .form-grid input:focus,
    .form-grid select:focus,
    #delete_employee_id:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.18);
    }

    .actions { display: flex; gap: 10px; margin-top: 10px; }

    #addMsg, #deleteMsg { margin: 10px 0 0; font-size: 14px; font-weight: 700; }

    .table-wrap {
      overflow: auto;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #fff;
      margin-top: 12px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 560px;
    }

    th, td {
      padding: 12px 12px;
      text-align: left;
      border-bottom: 1px solid #eef2f7;
      font-size: 14px;
    }

    /* Sticky header + zebra for professional feel */
    thead th { position: sticky; top: 0; z-index: 1; background: #f8fafc; }
    tbody tr:nth-child(even) td { background: #fcfcff; }

    tr:hover td { background: #f9fafb; }

    .muted { color: #6b7280; font-size: 13px; margin: 6px 0 0; }

    .search-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .search-row input {
      flex: 1;
      min-width: 220px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      outline: none;
      font-size: 14px;
      background: #fff;
      transition: 0.2s ease;
    }

    .search-row input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.18);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      font-weight: 900;
      color: #0f172a;
      font-size: 13px;
      white-space: nowrap;
    }

    .badge {
      display:inline-block; padding:6px 10px; border-radius:999px;
      font-weight:900; font-size:12px; border:1px solid;
    }
    .badge.admin { background:#fee2e2; color:#991b1b; border-color:#fecaca; }
    .badge.employee { background:#dcfce7; color:#166534; border-color:#bbf7d0; }

    .stats {
      margin-top: 16px;
      display:grid;
      gap:12px;
      grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
    }

    .statNum { font-size: 28px; font-weight: 900; margin-top: 6px; }
    .statMeta { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:10px; color:#64748b; font-size:12px; font-weight:800; }

    .note {
      margin-top: 12px;
      font-size: 12px;
      color: rgba(255,255,255,0.85);
      text-align: center;
    }

    /* Toast */
    #toast {
      position: fixed;
      top: 18px;
      right: 18px;
      z-index: 9999;
      padding: 12px 14px;
      border-radius: 12px;
      display: none;
      font-weight: 900;
      box-shadow: 0 16px 30px rgba(0,0,0,.18);
      color: #fff;
      max-width: 320px;
    }
  </style>
</head>

<body>
  <div id="toast"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h2>Admin Dashboard</h2>
          <p class="sub">Manage employees and monitor login logs</p>
        </div>
      </div>

      <div class="right">
        <div class="chip">Welcome, <span id="adminName"></span></div>
        <button class="btn secondary" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- ✅ Professional Stats Row -->
    <div class="stats">
      <div class="card">
        <div class="muted">Total Employees</div>
        <div class="statNum" id="statTotalEmp">0</div>
        <div class="statMeta"><span>Updated</span><span id="statUpdated1">—</span></div>
      </div>
      <div class="card">
        <div class="muted">Today Logins</div>
        <div class="statNum" id="statLogins">0</div>
        <div class="statMeta"><span>Today</span><span id="statUpdated2">—</span></div>
      </div>
      <div class="card">
        <div class="muted">Today Logouts</div>
        <div class="statNum" id="statLogouts">0</div>
        <div class="statMeta"><span>Today</span><span id="statUpdated3">—</span></div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT COLUMN -->
      <div style="display:flex; flex-direction:column; gap:16px;">
        <!-- Add Employee -->
        <div class="card">
          <h3>Add New Employee</h3>
          <p class="muted">Create employee/admin accounts securely.</p>

          <div class="form-grid">
            <input type="text" id="employee_id" placeholder="Employee ID" />
            <input type="text" id="name" placeholder="Name" />
            <input type="email" id="email" placeholder="Email" />
            <input type="password" id="password" placeholder="Password" />

            <select id="role">
              <option value="employee">Employee</option>
              <option value="admin">Admin</option>
            </select>
          </div>

          <div class="actions">
            <button class="btn" id="btnAddEmp" onclick="addEmployee()">Add Employee</button>
            <button class="btn secondary" onclick="clearForm()">Clear</button>
          </div>

          <p id="addMsg"></p>
        </div>

        <!-- Delete Employee -->
        <div class="card">
          <h3>Delete Employee</h3>
          <p class="muted">Remove employee from system permanently.</p>

          <input type="text" id="delete_employee_id" placeholder="Enter Employee ID" />

          <div class="actions">
            <button class="btn secondary" id="btnDelEmp" onclick="deleteEmployee()">Delete Employee</button>
          </div>

          <p id="deleteMsg"></p>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div style="display:flex; flex-direction:column; gap:16px;">
        <!-- Employees -->
        <div class="card">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <div>
              <h3 style="margin:0;">Employees</h3>
              <p class="muted">Total employees and recently added accounts.</p>
            </div>
            <div class="pill">Total: <span id="empCount">0</span></div>
          </div>

          <div class="search-row">
            <input
              type="text"
              id="empSearch"
              placeholder="Search employees (id, name, email, role...)"
              oninput="filterEmployees()"
            />
            <button class="btn secondary" onclick="clearEmpSearch()">Clear</button>
            <button class="btn" onclick="fetchEmployees()">Refresh</button>
          </div>

          <div class="table-wrap">
            <table id="employeesTable">
              <thead>
                <tr>
                  <th>Employee ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Logs -->
        <div class="card">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <div>
              <h3 style="margin:0;">Employee Logs</h3>
              <p class="muted">Track login/logout events in real time.</p>
            </div>
            <button class="btn" onclick="fetchLogs()">Refresh Logs</button>
          </div>

          <div class="search-row">
            <input
              type="text"
              id="logSearch"
              placeholder="Search logs (employee id, action, time...)"
              oninput="filterLogs()"
            />
            <button class="btn secondary" onclick="clearSearch()">Clear</button>
          </div>

          <div class="table-wrap">
            <table id="logsTable">
              <thead>
                <tr>
                  <th>Employee ID</th>
                  <th>Action</th>
                  <th>Timestamp</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="note">Employee Login Automation • Admin Panel</div>
  </div>

  <script>
    const role = localStorage.getItem("role");
    const token = localStorage.getItem("token");
    const adminName = localStorage.getItem("employee_name");
    const BASE_URL = window.location.origin;

    document.getElementById("adminName").innerText = adminName || "Admin";

    if (!token) window.location.href = "login.html";
    if (role !== "admin") window.location.href = "employee.html";

    let allLogs = [];
    let allEmployees = [];

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("role");
      localStorage.removeItem("employee_id");
      localStorage.removeItem("employee_name");
      window.location.href = "login.html";
    }

    function clearForm() {
      document.getElementById("employee_id").value = "";
      document.getElementById("name").value = "";
      document.getElementById("email").value = "";
      document.getElementById("password").value = "";
      document.getElementById("role").value = "employee";
      document.getElementById("addMsg").innerText = "";
    }

    function setMsg(el, text, ok) {
      el.innerText = text || "";
      el.style.color = ok ? "green" : "red";
    }

    function showToast(text, ok = true) {
      const t = document.getElementById("toast");
      t.textContent = text || "";
      t.style.display = "block";
      t.style.background = ok ? "#16a34a" : "#ef4444";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => (t.style.display = "none"), 2200);
    }

    function setBtnLoading(btn, loading, textWhenLoading = "Please wait...") {
      if (!btn) return;
      btn.disabled = loading;
      btn.dataset.oldText = btn.dataset.oldText || btn.innerText;
      btn.innerText = loading ? textWhenLoading : btn.dataset.oldText;
    }

    function nowTimeStr() {
      return new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function refreshPage(delayMs = 650) {
      setTimeout(() => window.location.reload(), delayMs);
    }

    async function fetchStats() {
      document.getElementById("statTotalEmp").innerText = allEmployees.length;
      document.getElementById("statUpdated1").innerText = nowTimeStr();

      try {
        const res = await fetch(BASE_URL + "/api/admin/report/daily", {
          headers: { "Authorization": "Bearer " + token }
        });
        const data = await res.json();
        if (!res.ok) return;

        const totals = (Array.isArray(data) ? data : []).reduce((acc, r) => {
          acc.logins += Number(r.logins || 0);
          acc.logouts += Number(r.logouts || 0);
          return acc;
        }, { logins: 0, logouts: 0 });

        document.getElementById("statLogins").innerText = totals.logins;
        document.getElementById("statLogouts").innerText = totals.logouts;
        document.getElementById("statUpdated2").innerText = nowTimeStr();
        document.getElementById("statUpdated3").innerText = nowTimeStr();
      } catch {}
    }

    // -----------------------
    // ADD EMPLOYEE
    // -----------------------
    async function addEmployee() {
      const id = document.getElementById("employee_id").value.trim();
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const roleValue = document.getElementById("role").value;

      const addMsg = document.getElementById("addMsg");
      const btn = document.getElementById("btnAddEmp");

      setMsg(addMsg, "", false);

      if (!id || !name || !email || !password || !roleValue) {
        setMsg(addMsg, "All fields are required", false);
        showToast("❌ Please fill all fields", false);
        return;
      }

      try {
        setBtnLoading(btn, true, "Adding...");
        const response = await fetch(BASE_URL + "/api/admin/add-employee", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({ employee_id: id, name, email, password, role: roleValue })
        });

        const data = await response.json();

        if (!response.ok) {
          setMsg(addMsg, data.message || "Failed to add employee", false);
          showToast(data.message || "❌ Failed to add employee", false);
          return;
        }

        setMsg(addMsg, data.message || "✅ New employee added successfully", true);
        showToast(data.message || "✅ Employee added successfully", true);

        clearForm();

        // ✅ Full page refresh so everything updates automatically
        refreshPage();

      } catch (error) {
        console.error(error);
        setMsg(addMsg, "Cannot connect to server", false);
        showToast("❌ Cannot connect to server", false);
      } finally {
        setBtnLoading(btn, false);
      }
    }

    // -----------------------
    // DELETE EMPLOYEE
    // -----------------------
    async function deleteEmployee() {
      const employeeId = document.getElementById("delete_employee_id").value.trim();
      const deleteMsg = document.getElementById("deleteMsg");
      const btn = document.getElementById("btnDelEmp");

      setMsg(deleteMsg, "", false);

      if (!employeeId) {
        setMsg(deleteMsg, "Employee ID is required", false);
        showToast("❌ Employee ID is required", false);
        return;
      }

      if (!confirm("Are you sure you want to delete employee: " + employeeId + " ?")) return;

      try {
        setBtnLoading(btn, true, "Deleting...");
        const res = await fetch(
          BASE_URL + "/api/admin/employees/" + encodeURIComponent(employeeId),
          {
            method: "DELETE",
            headers: { "Authorization": "Bearer " + token }
          }
        );

        const data = await res.json();

        if (!res.ok) {
          setMsg(deleteMsg, data.message || "Delete failed", false);
          showToast(data.message || "❌ Delete failed", false);
          return;
        }

        setMsg(deleteMsg, data.message || "Employee deleted successfully", true);
        showToast(data.message || "✅ Employee deleted", true);
        document.getElementById("delete_employee_id").value = "";

        // ✅ Full page refresh so everything updates automatically
        refreshPage();

      } catch (error) {
        console.error(error);
        setMsg(deleteMsg, "Cannot connect to server", false);
        showToast("❌ Cannot connect to server", false);
      } finally {
        setBtnLoading(btn, false);
      }
    }

    // -----------------------
    // EMPLOYEES LIST + COUNT
    // -----------------------
    function renderEmployees(list) {
      const tbody = document.querySelector("#employeesTable tbody");
      const countEl = document.getElementById("empCount");

      tbody.innerHTML = "";
      countEl.innerText = (list || []).length;

      if (!list || list.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4">No employees found</td></tr>`;
        return;
      }

      list.forEach(emp => {
        const tr = document.createElement("tr");
        const roleLower = String(emp.role || "").toLowerCase();
        const roleClass = roleLower === "admin" ? "admin" : "employee";
        tr.innerHTML = `
          <td>${emp.employee_id || ""}</td>
          <td>${emp.name || ""}</td>
          <td>${emp.email || ""}</td>
          <td><span class="badge ${roleClass}">${emp.role || ""}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filterEmployees() {
      const q = (document.getElementById("empSearch").value || "").toLowerCase().trim();
      if (!q) return renderEmployees(allEmployees);

      const filtered = allEmployees.filter(emp => {
        const text = `${emp.employee_id} ${emp.name} ${emp.email} ${emp.role}`.toLowerCase();
        return text.includes(q);
      });

      renderEmployees(filtered);
    }

    function clearEmpSearch() {
      document.getElementById("empSearch").value = "";
      renderEmployees(allEmployees);
    }

    async function fetchEmployees() {
      const tbody = document.querySelector("#employeesTable tbody");
      tbody.innerHTML = `<tr><td colspan="4">Loading...</td></tr>`;

      try {
        const response = await fetch(BASE_URL + "/api/admin/employees", {
          headers: { "Authorization": "Bearer " + token }
        });

        const data = await response.json();

        if (!response.ok) {
          tbody.innerHTML = `<tr><td colspan="4">Error: ${data.message || "Failed"}</td></tr>`;
          document.getElementById("empCount").innerText = "0";
          allEmployees = [];
          fetchStats();
          return;
        }

        const list = Array.isArray(data) ? data : (data.employees || []);
        allEmployees = list;
        renderEmployees(allEmployees);
        filterEmployees();
        fetchStats();

      } catch (error) {
        console.error(error);
        tbody.innerHTML = `<tr><td colspan="4">Cannot connect to server</td></tr>`;
        document.getElementById("empCount").innerText = "0";
        allEmployees = [];
        fetchStats();
      }
    }

    // -----------------------
    // LOGS
    // -----------------------
    function renderLogs(logs) {
      const tbody = document.querySelector("#logsTable tbody");
      tbody.innerHTML = "";

      if (!logs || logs.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3">No logs found</td></tr>`;
        return;
      }

      logs.forEach(log => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${log.employee_id}</td><td>${log.action}</td><td>${log.timestamp}</td>`;
        tbody.appendChild(tr);
      });
    }

    function filterLogs() {
      const q = (document.getElementById("logSearch").value || "").toLowerCase().trim();
      if (!q) return renderLogs(allLogs);

      const filtered = allLogs.filter(log => {
        const text = `${log.employee_id} ${log.action} ${log.timestamp}`.toLowerCase();
        return text.includes(q);
      });

      renderLogs(filtered);
    }

    function clearSearch() {
      document.getElementById("logSearch").value = "";
      renderLogs(allLogs);
    }

    async function fetchLogs() {
      const tbody = document.querySelector("#logsTable tbody");
      tbody.innerHTML = `<tr><td colspan="3">Loading...</td></tr>`;

      try {
        const response = await fetch(BASE_URL + "/api/admin/logs", {
          headers: { "Authorization": "Bearer " + token }
        });

        const data = await response.json();

        if (!response.ok) {
          tbody.innerHTML = `<tr><td colspan="3">Error: ${data.message}</td></tr>`;
          allLogs = [];
          return;
        }

        allLogs = Array.isArray(data) ? data : [];
        renderLogs(allLogs);
        filterLogs();

      } catch (error) {
        console.error(error);
        tbody.innerHTML = `<tr><td colspan="3">Cannot connect to server</td></tr>`;
        allLogs = [];
      }
    }

    // Initial loads
    fetchEmployees();
    fetchLogs();
    fetchStats();
  </script>
</body>
</html>
