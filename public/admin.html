<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
      background: linear-gradient(135deg, #4f46e5, #9333ea);
      min-height: 100vh;
      padding: 22px;
      color: #111827;
    }

    .wrap { max-width: 1100px; margin: 0 auto; }

    .topbar {
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid rgba(255,255,255,0.7);
      border-radius: 16px;
      padding: 16px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.18);
      backdrop-filter: blur(8px);
    }

    .brand { display: flex; gap: 12px; align-items: center; }

    .logo {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, #4f46e5, #9333ea);
      box-shadow: 0 10px 20px rgba(79, 70, 229, 0.35);
    }

    .brand h2 { margin: 0; font-size: 18px; font-weight: 800; letter-spacing: 0.2px; }
    .sub { margin: 2px 0 0; font-size: 13px; color: #4b5563; font-weight: 600; }

    .right { display: flex; gap: 10px; align-items: center; }

    .chip {
      padding: 8px 10px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      font-weight: 700;
      font-size: 13px;
      border: 1px solid #e0e7ff;
      white-space: nowrap;
    }

    .btn {
      border: none;
      cursor: pointer;
      font-weight: 800;
      border-radius: 10px;
      padding: 10px 12px;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      background: linear-gradient(135deg, #4f46e5, #9333ea);
      color: #fff;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 22px rgba(79, 70, 229, 0.35);
    }

    .btn.secondary {
      background: #ffffff;
      color: #111827;
      border: 1px solid #e5e7eb;
      box-shadow: none;
    }

    .btn.secondary:hover { box-shadow: 0 10px 18px rgba(0,0,0,0.08); }

    .grid {
      margin-top: 16px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    @media (min-width: 900px) {
      .grid { grid-template-columns: 420px 1fr; align-items: start; }
    }

    .card {
      background: rgba(255, 255, 255, 0.94);
      border: 1px solid rgba(255,255,255,0.7);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.18);
      backdrop-filter: blur(8px);
    }

    .card h3 { margin: 0 0 12px; font-size: 16px; font-weight: 900; }

    .form-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }

    .form-grid input,
    .form-grid select,
    #delete_employee_id {
      width: 100%;
      padding: 12px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      outline: none;
      font-size: 14px;
      background: #fff;
      transition: 0.2s ease;
    }

    .form-grid input:focus,
    .form-grid select:focus,
    #delete_employee_id:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.18);
    }

    .actions { display: flex; gap: 10px; margin-top: 10px; }

    #addMsg, #deleteMsg { margin: 10px 0 0; font-size: 14px; font-weight: 600; }

    .table-wrap {
      overflow: auto;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #fff;
      margin-top: 12px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 560px;
    }

    th, td {
      padding: 12px 12px;
      text-align: left;
      border-bottom: 1px solid #eef2f7;
      font-size: 14px;
    }

    th { background: #f8fafc; color: #111827; font-weight: 900; }
    tr:hover td { background: #f9fafb; }

    .muted { color: #6b7280; font-size: 13px; margin: 6px 0 0; }

    .search-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .search-row input {
      flex: 1;
      min-width: 220px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      outline: none;
      font-size: 14px;
      background: #fff;
      transition: 0.2s ease;
    }

    .search-row input:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.18);
    }

    .note {
      margin-top: 12px;
      font-size: 12px;
      color: rgba(255,255,255,0.85);
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h2>Admin Dashboard</h2>
          <p class="sub">Manage employees and monitor login logs</p>
        </div>
      </div>

      <div class="right">
        <div class="chip">Welcome, <span id="adminName"></span></div>
        <button class="btn secondary" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- ✅ NEW LAYOUT -->
    <div class="grid">
      <!-- LEFT COLUMN: Add + Delete -->
      <div style="display:flex; flex-direction:column; gap:16px;">
        <!-- Add Employee -->
        <div class="card">
          <h3>Add New Employee</h3>
          <p class="muted">Create employee/admin accounts securely.</p>

          <div class="form-grid">
            <input type="text" id="employee_id" placeholder="Employee ID" />
            <input type="text" id="name" placeholder="Name" />
            <input type="email" id="email" placeholder="Email" />
            <input type="password" id="password" placeholder="Password" />

            <select id="role">
              <option value="employee">Employee</option>
              <option value="admin">Admin</option>
            </select>
          </div>

          <div class="actions">
            <button class="btn" onclick="addEmployee()">Add Employee</button>
            <button class="btn secondary" onclick="clearForm()">Clear</button>
          </div>

          <p id="addMsg"></p>
        </div>

        <!-- Delete Employee (BOTTOM) -->
        <div class="card">
          <h3>Delete Employee</h3>
          <p class="muted">Remove employee from system permanently.</p>

          <input type="text" id="delete_employee_id" placeholder="Enter Employee ID" />

          <div class="actions">
            <button class="btn secondary" onclick="deleteEmployee()">Delete Employee</button>
          </div>

          <p id="deleteMsg"></p>
        </div>
      </div>

      <!-- RIGHT COLUMN: Logs -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
          <div>
            <h3 style="margin:0;">Employee Logs</h3>
            <p class="muted">Track login/logout events in real time.</p>
          </div>
          <button class="btn" onclick="fetchLogs()">Refresh Logs</button>
        </div>

        <div class="search-row">
          <input
            type="text"
            id="logSearch"
            placeholder="Search logs (employee id, action, time...)"
            oninput="filterLogs()"
          />
          <button class="btn secondary" onclick="clearSearch()">Clear</button>
        </div>

        <div class="table-wrap">
          <table id="logsTable">
            <thead>
              <tr>
                <th>Employee ID</th>
                <th>Action</th>
                <th>Timestamp</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="note">Employee Login Automation • Admin Panel</div>
  </div>

  <script>
    const role = localStorage.getItem("role");
    const token = localStorage.getItem("token");
    const adminName = localStorage.getItem("employee_name");
    const BASE_URL = window.location.origin;

    document.getElementById("adminName").innerText = adminName || "Admin";

    if (!token) window.location.href = "login.html";
    if (role !== "admin") window.location.href = "employee.html";

    let allLogs = [];

    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("role");
      localStorage.removeItem("employee_id");
      localStorage.removeItem("employee_name");
      window.location.href = "login.html";
    }

    function clearForm() {
      document.getElementById("employee_id").value = "";
      document.getElementById("name").value = "";
      document.getElementById("email").value = "";
      document.getElementById("password").value = "";
      document.getElementById("role").value = "employee";
      document.getElementById("addMsg").innerText = "";
    }

    async function addEmployee() {
      const id = document.getElementById("employee_id").value.trim();
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const role = document.getElementById("role").value;

      const addMsg = document.getElementById("addMsg");
      addMsg.innerText = "";
      addMsg.style.color = "red";

      if (!id || !name || !email || !password || !role) {
        addMsg.innerText = "All fields are required";
        return;
      }

      try {
        const response = await fetch(BASE_URL + "/api/admin/add-employee", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({ employee_id: id, name, email, password, role })
        });

        const data = await response.json();

        if (!response.ok) {
          addMsg.style.color = "red";
          addMsg.innerText = data.message || "Failed to add employee";
          return;
        }

        addMsg.style.color = "green";
        addMsg.innerText = "Employee added successfully";
        clearForm();

      } catch (error) {
        console.error(error);
        addMsg.style.color = "red";
        addMsg.innerText = "Cannot connect to server";
      }
    }

    async function deleteEmployee() {
      const employeeId = document.getElementById("delete_employee_id").value.trim();
      const deleteMsg = document.getElementById("deleteMsg");

      deleteMsg.innerText = "";
      deleteMsg.style.color = "red";

      if (!employeeId) {
        deleteMsg.innerText = "Employee ID is required";
        return;
      }

      if (!confirm("Are you sure you want to delete employee: " + employeeId + " ?")) return;

      try {
        const res = await fetch(
          BASE_URL + "/api/admin/employees/" + encodeURIComponent(employeeId),
          {
            method: "DELETE",
            headers: { "Authorization": "Bearer " + token }
          }
        );

        const data = await res.json();

        if (!res.ok) {
          deleteMsg.innerText = data.message || "Delete failed";
          return;
        }

        deleteMsg.style.color = "green";
        deleteMsg.innerText = "Employee deleted successfully";
        document.getElementById("delete_employee_id").value = "";

      } catch (error) {
        console.error(error);
        deleteMsg.innerText = "Cannot connect to server";
      }
    }

    function renderLogs(logs) {
      const tbody = document.querySelector("#logsTable tbody");
      tbody.innerHTML = "";

      if (!logs || logs.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3">No logs found</td></tr>`;
        return;
      }

      logs.forEach(log => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${log.employee_id}</td><td>${log.action}</td><td>${log.timestamp}</td>`;
        tbody.appendChild(tr);
      });
    }

    function filterLogs() {
      const q = (document.getElementById("logSearch").value || "").toLowerCase().trim();
      if (!q) return renderLogs(allLogs);

      const filtered = allLogs.filter(log => {
        const text = `${log.employee_id} ${log.action} ${log.timestamp}`.toLowerCase();
        return text.includes(q);
      });

      renderLogs(filtered);
    }

    function clearSearch() {
      document.getElementById("logSearch").value = "";
      renderLogs(allLogs);
    }

    async function fetchLogs() {
      const tbody = document.querySelector("#logsTable tbody");
      tbody.innerHTML = "";

      try {
        const response = await fetch(BASE_URL + "/api/admin/logs", {
          headers: { "Authorization": "Bearer " + token }
        });

        const data = await response.json();

        if (!response.ok) {
          tbody.innerHTML = `<tr><td colspan="3">Error: ${data.message}</td></tr>`;
          return;
        }

        allLogs = Array.isArray(data) ? data : [];
        renderLogs(allLogs);
        filterLogs();

      } catch (error) {
        console.error(error);
        tbody.innerHTML = `<tr><td colspan="3">Cannot connect to server</td></tr>`;
      }
    }

    fetchLogs();
  </script>
</body>
</html>
