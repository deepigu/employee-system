<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
      background: linear-gradient(135deg, #4f46e5, #9333ea);
      min-height: 100vh;
      padding: 22px;
      color: #111827;
    }
    .wrap { max-width: 1100px; margin: 0 auto; }

    .topbar {
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid rgba(255,255,255,0.7);
      border-radius: 16px;
      padding: 16px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.18);
      backdrop-filter: blur(8px);
    }
    .brand { display: flex; gap: 12px; align-items: center; }
    .logo {
      width: 40px; height: 40px; border-radius: 12px;
      background: linear-gradient(135deg, #4f46e5, #9333ea);
      box-shadow: 0 10px 20px rgba(79, 70, 229, 0.35);
    }
    .brand h2 { margin: 0; font-size: 18px; font-weight: 800; letter-spacing: 0.2px; }
    .sub { margin: 2px 0 0; font-size: 13px; color: #4b5563; font-weight: 600; }

    .right { display: flex; gap: 10px; align-items: center; }
    .chip {
      padding: 8px 10px; border-radius: 999px;
      background: #eef2ff; color: #3730a3;
      font-weight: 700; font-size: 13px;
      border: 1px solid #e0e7ff; white-space: nowrap;
    }

    .btn {
      border: none; cursor: pointer; font-weight: 800;
      border-radius: 10px; padding: 10px 12px;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      background: linear-gradient(135deg, #4f46e5, #9333ea);
      color: #fff;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 12px 22px rgba(79, 70, 229, 0.35); }
    .btn.secondary { background: #ffffff; color: #111827; border: 1px solid #e5e7eb; box-shadow: none; }
    .btn.secondary:hover { box-shadow: 0 10px 18px rgba(0,0,0,0.08); }

    /* Stats */
    .stats {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    @media (max-width: 980px) { .stats { grid-template-columns: repeat(2, 1fr); } }
    .stat {
      background: rgba(255,255,255,0.94);
      border: 1px solid rgba(255,255,255,0.7);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.14);
      backdrop-filter: blur(8px);
    }
    .stat .label { color:#6b7280; font-weight:800; font-size:12px; }
    .stat .value { font-size:22px; font-weight:1000; margin-top:6px; color:#0f172a; }

    .grid { margin-top: 16px; display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 420px 1fr; align-items: start; } }

    .card {
      background: rgba(255, 255, 255, 0.94);
      border: 1px solid rgba(255,255,255,0.7);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.18);
      backdrop-filter: blur(8px);
    }
    .card h3 { margin: 0 0 12px; font-size: 16px; font-weight: 900; }
    .muted { color: #6b7280; font-size: 13px; margin: 6px 0 0; }

    .form-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
    .form-grid input, .form-grid select, #delete_employee_id {
      width: 100%; padding: 12px 12px; border-radius: 10px;
      border: 1px solid #d1d5db; outline: none; font-size: 14px;
      background: #fff; transition: 0.2s ease;
    }
    .form-grid input:focus, .form-grid select:focus, #delete_employee_id:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.18);
    }
    .actions { display: flex; gap: 10px; margin-top: 10px; }
    #addMsg, #deleteMsg { margin: 10px 0 0; font-size: 14px; font-weight: 700; }

    .search-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 12px; }
    .search-row input {
      flex: 1; min-width: 220px; padding: 12px;
      border-radius: 10px; border: 1px solid #d1d5db;
      outline: none; font-size: 14px; background: #fff; transition: 0.2s ease;
    }
    .search-row input:focus { border-color: #4f46e5; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.18); }

    .table-wrap { overflow: auto; border-radius: 12px; border: 1px solid #e5e7eb; background: #fff; margin-top: 12px; }
    table { border-collapse: collapse; width: 100%; min-width: 560px; }
    th, td { padding: 12px 12px; text-align: left; border-bottom: 1px solid #eef2f7; font-size: 14px; }
    th { background: #f8fafc; color: #111827; font-weight: 900; }
    tr:hover td { background: #f9fafb; }

    .badge { display:inline-flex; padding: 6px 10px; border-radius: 999px; font-weight: 900; font-size: 12px; border: 1px solid #e5e7eb; }
    .b-working { background:#ecfdf5; color:#047857; border-color:#a7f3d0; }
    .b-break   { background:#fffbeb; color:#b45309; border-color:#fde68a; }
    .b-out     { background:#fef2f2; color:#b91c1c; border-color:#fecaca; }
    .b-never   { background:#f1f5f9; color:#334155; border-color:#e2e8f0; }

    .note { margin-top: 12px; font-size: 12px; color: rgba(255,255,255,0.85); text-align: center; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h2>Admin Dashboard</h2>
          <p class="sub">Manage employees and monitor login logs</p>
        </div>
      </div>

      <div class="right">
        <div class="chip">Welcome, <span id="adminName"></span></div>
        <button class="btn secondary" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats">
      <div class="stat">
        <div class="label">Total Employees</div>
        <div class="value" id="statTotalEmployees">0</div>
      </div>
      <div class="stat">
        <div class="label">Today Logins</div>
        <div class="value" id="statTodayLogins">0</div>
      </div>
      <div class="stat">
        <div class="label">Today Logouts</div>
        <div class="value" id="statTodayLogouts">0</div>
      </div>
      <div class="stat">
        <div class="label">On Break Now</div>
        <div class="value" id="statOnBreakNow">0</div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div style="display:flex; flex-direction:column; gap:16px;">
        <div class="card">
          <h3>Add New Employee</h3>
          <p class="muted">Create employee/admin accounts securely.</p>

          <div class="form-grid">
            <input type="text" id="employee_id" placeholder="Employee ID" />
            <input type="text" id="name" placeholder="Name" />
            <input type="email" id="email" placeholder="Email" />
            <input type="password" id="password" placeholder="Password" />
            <select id="role">
              <option value="employee">Employee</option>
              <option value="admin">Admin</option>
            </select>
          </div>

          <div class="actions">
            <button class="btn" onclick="addEmployee()">Add Employee</button>
            <button class="btn secondary" onclick="clearForm()">Clear</button>
          </div>
          <p id="addMsg"></p>
        </div>

        <div class="card">
          <h3>Delete Employee</h3>
          <p class="muted">Remove employee from system permanently.</p>

          <input type="text" id="delete_employee_id" placeholder="Enter Employee ID" />
          <div class="actions">
            <button class="btn secondary" onclick="deleteEmployee()">Delete Employee</button>
          </div>
          <p id="deleteMsg"></p>
        </div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <div>
              <h3 style="margin:0;">Live Status</h3>
              <p class="muted">Current status based on last action.</p>
            </div>
            <button class="btn" onclick="fetchLiveStatus()">Refresh</button>
          </div>

          <div class="table-wrap">
            <table id="liveTable">
              <thead>
                <tr>
                  <th>Employee</th>
                  <th>Status</th>
                  <th>Last Time</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div style="display:flex; flex-direction:column; gap:16px;">
        <div class="card">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <div>
              <h3 style="margin:0;">Employees</h3>
              <p class="muted">Manage all accounts.</p>
            </div>
            <div class="chip">Total: <span id="empCount">0</span></div>
          </div>

          <div class="search-row">
            <input type="text" id="empSearch" placeholder="Search employees..." oninput="filterEmployees()" />
            <button class="btn secondary" onclick="clearEmpSearch()">Clear</button>
            <button class="btn" onclick="fetchEmployees()">Refresh</button>
          </div>

          <div class="table-wrap">
            <table id="employeesTable">
              <thead>
                <tr>
                  <th>Employee ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <div>
              <h3 style="margin:0;">Employee Logs</h3>
              <p class="muted">Track login/logout/break events.</p>
            </div>
            <button class="btn" onclick="fetchLogs()">Refresh Logs</button>
          </div>

          <div class="search-row">
            <input type="text" id="logSearch" placeholder="Search logs..." oninput="filterLogs()" />
            <button class="btn secondary" onclick="clearSearch()">Clear</button>
          </div>

          <div class="table-wrap">
            <table id="logsTable">
              <thead>
                <tr>
                  <th>Employee ID</th>
                  <th>Action</th>
                  <th>Timestamp</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="note">Employee Login Automation • Admin Panel</div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    const role = localStorage.getItem("role");
    const adminName = localStorage.getItem("employee_name");

    // ✅ IMPORTANT: Force SAME API server as employee page
    const BASE_URL = "https://employee-system-84mh.onrender.com";

    document.getElementById("adminName").innerText = adminName || "Admin";
    if (!token) window.location.href = "login.html";
    if (role !== "admin") window.location.href = "employee.html";

    let allEmployees = [];
    let allLogs = [];

    function logout() {
      localStorage.clear();
      window.location.href = "login.html";
    }

    function setMsg(el, text, ok) {
      el.innerText = text || "";
      el.style.color = ok ? "green" : "red";
    }

    function clearForm() {
      document.getElementById("employee_id").value = "";
      document.getElementById("name").value = "";
      document.getElementById("email").value = "";
      document.getElementById("password").value = "";
      document.getElementById("role").value = "employee";
      document.getElementById("addMsg").innerText = "";
    }

    // ✅ Stats
    async function fetchStats() {
      try {
        const res = await fetch(BASE_URL + "/api/admin/stats/today", {
          headers: { "Authorization": "Bearer " + token }
        });
        const data = await res.json();
        if (!res.ok) return;

        document.getElementById("statTotalEmployees").innerText = data.totalEmployees ?? 0;
        document.getElementById("statTodayLogins").innerText = data.todayLogins ?? 0;
        document.getElementById("statTodayLogouts").innerText = data.todayLogouts ?? 0;
        document.getElementById("statOnBreakNow").innerText = data.onBreakNow ?? 0;
      } catch (e) {}
    }

    // ✅ Add employee
    async function addEmployee() {
      const id = document.getElementById("employee_id").value.trim();
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const roleValue = document.getElementById("role").value;
      const msg = document.getElementById("addMsg");

      setMsg(msg, "", false);

      if (!id || !name || !email || !password || !roleValue) {
        setMsg(msg, "All fields are required", false);
        return;
      }

      try {
        const res = await fetch(BASE_URL + "/api/admin/add-employee", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({ employee_id: id, name, email, password, role: roleValue })
        });

        const data = await res.json();
        if (!res.ok) {
          setMsg(msg, data.message || "Failed to add employee", false);
          return;
        }

        setMsg(msg, data.message || "✅ Employee added", true);
        clearForm();
        await refreshAll();
      } catch (e) {
        setMsg(msg, "Cannot connect to server", false);
      }
    }

    // ✅ Delete employee
    async function deleteEmployee() {
      const employeeId = document.getElementById("delete_employee_id").value.trim();
      const msg = document.getElementById("deleteMsg");
      setMsg(msg, "", false);

      if (!employeeId) {
        setMsg(msg, "Employee ID is required", false);
        return;
      }
      if (!confirm("Delete employee: " + employeeId + " ?")) return;

      try {
        const res = await fetch(BASE_URL + "/api/admin/employees/" + encodeURIComponent(employeeId), {
          method: "DELETE",
          headers: { "Authorization": "Bearer " + token }
        });

        const data = await res.json();
        if (!res.ok) {
          setMsg(msg, data.message || "Delete failed", false);
          return;
        }

        setMsg(msg, data.message || "✅ Deleted", true);
        document.getElementById("delete_employee_id").value = "";
        await refreshAll();
      } catch (e) {
        setMsg(msg, "Cannot connect to server", false);
      }
    }

    // Employees
    function renderEmployees(list) {
      const tbody = document.querySelector("#employeesTable tbody");
      document.getElementById("empCount").innerText = (list || []).length;
      tbody.innerHTML = "";

      if (!list || !list.length) {
        tbody.innerHTML = `<tr><td colspan="4">No employees found</td></tr>`;
        return;
      }

      list.forEach(emp => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${emp.employee_id || ""}</td>
          <td>${emp.name || ""}</td>
          <td>${emp.email || ""}</td>
          <td>${emp.role || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filterEmployees() {
      const q = (document.getElementById("empSearch").value || "").toLowerCase().trim();
      if (!q) return renderEmployees(allEmployees);

      renderEmployees(allEmployees.filter(emp =>
        (`${emp.employee_id} ${emp.name} ${emp.email} ${emp.role}`).toLowerCase().includes(q)
      ));
    }

    function clearEmpSearch() {
      document.getElementById("empSearch").value = "";
      renderEmployees(allEmployees);
    }

    async function fetchEmployees() {
      const tbody = document.querySelector("#employeesTable tbody");
      tbody.innerHTML = `<tr><td colspan="4">Loading...</td></tr>`;

      try {
        const res = await fetch(BASE_URL + "/api/admin/employees", {
          headers: { "Authorization": "Bearer " + token }
        });

        const data = await res.json();
        if (!res.ok) {
          tbody.innerHTML = `<tr><td colspan="4">Error: ${data.message || "Failed"}</td></tr>`;
          allEmployees = [];
          return;
        }

        allEmployees = data.employees || [];
        renderEmployees(allEmployees);
        filterEmployees();
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="4">Cannot connect to server</td></tr>`;
        allEmployees = [];
      }
    }

    // Logs
    function renderLogs(list) {
      const tbody = document.querySelector("#logsTable tbody");
      tbody.innerHTML = "";

      if (!list || !list.length) {
        tbody.innerHTML = `<tr><td colspan="3">No logs found</td></tr>`;
        return;
      }

      list.forEach(l => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${l.employee_id}</td><td>${l.action}</td><td>${l.timestamp}</td>`;
        tbody.appendChild(tr);
      });
    }

    function filterLogs() {
      const q = (document.getElementById("logSearch").value || "").toLowerCase().trim();
      if (!q) return renderLogs(allLogs);

      renderLogs(allLogs.filter(l =>
        (`${l.employee_id} ${l.action} ${l.timestamp}`).toLowerCase().includes(q)
      ));
    }

    function clearSearch() {
      document.getElementById("logSearch").value = "";
      renderLogs(allLogs);
    }

    async function fetchLogs() {
      const tbody = document.querySelector("#logsTable tbody");
      tbody.innerHTML = `<tr><td colspan="3">Loading...</td></tr>`;

      try {
        const res = await fetch(BASE_URL + "/api/admin/logs", {
          headers: { "Authorization": "Bearer " + token }
        });

        const data = await res.json();
        if (!res.ok) {
          tbody.innerHTML = `<tr><td colspan="3">Error: ${data.message || "Failed"}</td></tr>`;
          allLogs = [];
          return;
        }

        allLogs = Array.isArray(data) ? data : [];
        renderLogs(allLogs);
        filterLogs();
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="3">Cannot connect to server</td></tr>`;
        allLogs = [];
      }
    }

    // Live status
    function badge(status) {
      if (status === "Working") return `<span class="badge b-working">Working</span>`;
      if (status === "On Break") return `<span class="badge b-break">On Break</span>`;
      if (status === "Logged Out") return `<span class="badge b-out">Logged Out</span>`;
      return `<span class="badge b-never">Never Logged In</span>`;
    }

    async function fetchLiveStatus() {
      const tbody = document.querySelector("#liveTable tbody");
      tbody.innerHTML = `<tr><td colspan="3">Loading...</td></tr>`;

      try {
        const res = await fetch(BASE_URL + "/api/admin/live-status", {
          headers: { "Authorization": "Bearer " + token }
        });

        const data = await res.json();
        if (!res.ok) {
          tbody.innerHTML = `<tr><td colspan="3">Error: ${data.message || "Failed"}</td></tr>`;
          return;
        }

        const list = data.employees || [];
        tbody.innerHTML = "";
        if (!list.length) {
          tbody.innerHTML = `<tr><td colspan="3">No employees found</td></tr>`;
          return;
        }

        list.forEach(e => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${e.employee_id} - ${e.name || ""}</td>
            <td>${badge(e.status)}</td>
            <td>${e.last_timestamp || "-"}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="3">Cannot connect to server</td></tr>`;
      }
    }

    async function refreshAll() {
      await fetchEmployees();
      await fetchStats();
      await fetchLiveStatus();
      await fetchLogs();
    }

    // ✅ initial load
    refreshAll();

    // ✅ auto-refresh stats + live status every 10 sec
    setInterval(() => {
      fetchStats();
      fetchLiveStatus();
    }, 10000);
  </script>
</body>
</html>
